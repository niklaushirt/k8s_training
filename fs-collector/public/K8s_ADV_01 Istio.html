<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>K8s_ADV_01 Istio</title>


<style type="text/css">
/*
   This document has been created with Marked.app <http://marked2app.com>
   Please leave this notice in place, along with any additional credits below.
   ---------------------------------------------------------------
   Title: Kult
   Author: Peter Sziebig - @bigpe
   Description: Easy to read
*/

@font-face {
    font-family: "Ubuntu";
    font-style: normal;
    font-weight: 300;
    src: local("Ubuntu Light"), local("Ubuntu-Light"), url("http://themes.googleusercontent.com/static/fonts/ubuntu/v4/WtcvfJHWXKxx4x0kuS1kobO3LdcAZYWl9Si6vvxL-qU.woff") format("woff");
}
@font-face {
    font-family: "Ubuntu";
    font-style: normal;
    font-weight: 400;
    src: local("Ubuntu"), url("http://themes.googleusercontent.com/static/fonts/ubuntu/v4/CGXpU_uR_FUfdeyCjAWgZ-vvDin1pK8aKteLpeZ5c0A.woff") format("woff");
}
@font-face {
    font-family: "Ubuntu";
    font-style: normal;
    font-weight: 500;
    src: local("Ubuntu Medium"), local("Ubuntu-Medium"), url("http://themes.googleusercontent.com/static/fonts/ubuntu/v4/gMhvhm-nVj1086DvGgmzB7O3LdcAZYWl9Si6vvxL-qU.woff") format("woff");
}
@font-face {
    font-family: "Ubuntu";
    font-style: normal;
    font-weight: 700;
    src: local("Ubuntu Bold"), local("Ubuntu-Bold"), url("http://themes.googleusercontent.com/static/fonts/ubuntu/v4/nsLtvfQoT-rVwGTHHnkeJrO3LdcAZYWl9Si6vvxL-qU.woff") format("woff");
}
@font-face {
    font-family: "Ubuntu";
    font-style: italic;
    font-weight: 300;
    src: local("Ubuntu Light Italic"), local("Ubuntu-LightItalic"), url("http://themes.googleusercontent.com/static/fonts/ubuntu/v4/DZ_YjBPqZ88vcZCcIXm6VqfTCPadK0KLfdEfFtGWCYw.woff") format("woff");
}



html {
    font-size: 100%;
}
html, button, input, select, textarea {
    font-family: sans-serif;
}

html, body, button, input, select, textarea {
    color: #57534A;
    font-family: "Ubuntu","Myriad Pro","Myriad",sans-serif;
    font-size: 18px;
	font-weight: 300;
}

body{
    margin: 0 auto;
    padding-top: 20px;
    background-color: #FFFFFF;
}

body, textarea {
    line-height: 1.4;
}


body:after {
    clear: both;
    content: "";
    display: table;
}

body {
    padding-left: 6rem;
    padding-right: 6rem;
    margin-left: auto;
    margin-right: auto;
    max-width: 42rem;
    display: block;
}



h1, h2, h3, dt {
    color: #423F37;
    font-weight: 700;
}

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}
h2, .article-list .article-title {
    font-size: 1.5em;
    margin: 0.83em 0;
}
h3, dt {
    font-size: 1.17em;
    margin: 1em 0;
}
h4 {
    font-size: 1em;
    margin: 1.33em 0;
}
h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}
h6 {
    font-size: 0.75em;
    margin: 2.33em 0;
}


a {
    color: #8DB359;
    cursor: pointer;
    outline: 0 none;
    text-decoration: underline;
}

a:hover {
    outline: 0 none;
    color: #739544;
}


p, pre {
    margin: 1em 0;
}
code, kbd, pre, samp {
    font-family: monospace,serif;
    font-size: 1em;
    margin: 0;
    padding: 0;

}
pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}

pre {
    background-color: #F8F5F0;
    font-size: 0.7rem;
    overflow-x: auto;
    padding: 1.3rem;
    position: relative;
    white-space: pre;
    word-wrap: normal;
}
pre, code, kbd, samp {
    margin: 0;
}
code, kbd, pre, samp {
    font-family: monospace,serif;
}

code {
    color: #423F37;
}


aside {
    display: block;
    float: right;
    width: 390px;
}


b, strong {
    font-weight: bold;
    color: #423F37;
    font-weight: 700;
}

blockquote {
    color: #423F37;
    font-size: 1.25em;
    font-weight: 700;
	margin: 1em 40px;
}

blockquote {
    margin-bottom: 2em;
    margin-top: 2em;
}

figure {
	margin-left: -4.5rem;
    margin-right: -4.5rem;
    margin-bottom: 2em;
    margin-top: 2em;
}


hr {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    border-color: -moz-use-text-color -moz-use-text-color #ECE6DA;
    border-image: none;
    border-style: none none solid;
    border-width: medium medium 1px;
    margin: 3em 6em;
}


img {
    max-width: 100%;
    display: block;
    border: 0 none;
}


ol > li:before {
    color: #423F37;
    content: counter(ol, decimal) ".";
    counter-increment: ol;
    font-weight: 700;
    margin-right: 0.333em;
    position: absolute;
    right: 100%;
}

ul > li:before {
    background-color: #423F37;
    border-radius: 14px 14px 14px 14px;
    content: "";
    height: 6px;
    margin-right: 0.333em;
    margin-top: 0.55em;
    position: absolute;
    right: 100%;
    width: 6px;
}

ol, ul, dl {
    margin-left: 2rem;
    padding: 0;
}
ol {
    counter-reset: ol;
}
li + li, dd + dt {
    margin-top: 0.5em;
}

ul > li {
    position: relative;
}

ol > li {
    position: relative;
}
li {
    list-style: none outside none;
}


figure > figcaption {
    margin-top: 0.5em;
}
small, dd, figcaption {
    color: #A19C91;
    display: block;
    font-size: 0.8rem;
    font-style: italic;
    line-height: 1.2;
}


tbody{display:table-row-group}
tfoot{display:table-footer-group}
table{margin-bottom:2em;font-size: 0.8em;padding:0;border-collapse:collapse;-webkit-box-shadow:1px 1px 2px rgba(0,0,0,.35);width:80%;margin:0 auto 2em auto}
table th,table td{padding:10px 10px 9px;line-height:18px;text-align:left}
table th{
padding-top:9px;!important;text-transform:uppercase;vertical-align:middle}
table td{vertical-align:top;border-top:1px solid #ddd;}
table tbody th{border-top:1px solid #ddd;vertical-align:top}
table{border:1px solid #ddd;border-collapse:separate;*border-collapse:collapse;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px}
table th+th,table td+td,table th+td{border-left:1px solid #ddd}
table thead tr:first-child th:first-child,table tbody tr:first-child td:first-child{-webkit-border-radius:4px 0 0 0;-moz-border-radius:4px 0 0 0;border-radius:4px 0 0 0}
table thead tr:first-child th:last-child,table tbody tr:first-child td:last-child{-webkit-border-radius:0 4px 0 0;-moz-border-radius:0 4px 0 0;border-radius:0 4px 0 0}
table tbody tr:last-child td:first-child{-webkit-border-radius:0 0 0 4px;-moz-border-radius:0 0 0 4px;border-radius:0 0 0 4px}
table tbody tr:last-child td:last-child{-webkit-border-radius:0 0 4px 0;-moz-border-radius:0 0 4px 0;border-radius:0 0 4px 0}
tbody tr:nth-child(odd){background-color:rgba(0,0,0,0.03)}

caption{display:table-caption;font-weight:300;font-size:1.3em;text-transform:uppercase;letter-spacing:2px;word-spacing:.2em;background:rgba(0,0,0,.75);color:#EEE;padding:4px;-webkit-border-radius:4px;margin:4px 0;-webkit-box-shadow:2px 2px 2px rgba(0,0,0,.35)}

/* grey out placeholders */
:-moz-placeholder {
  color: #bfbfbf;
}
::-webkit-input-placeholder {
  color: #bfbfbf;
}


.article-date {
    color: #C7C2B8;
    display: block;
    font-size: 0.8rem;
}
</style>

<style type="text/css">
/**
 * prism.js tomorrow night eighties for JavaScript, CoffeeScript, CSS and HTML
 * Based on https://github.com/chriskempson/tomorrow-theme
 * @author Rose Pritchard
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #ccc;
	background: none;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;

}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #2d2d2d;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.block-comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #999;
}

.token.punctuation {
	color: #ccc;
}

.token.tag,
.token.attr-name,
.token.namespace,
.token.deleted {
	color: #e2777a;
}

.token.function-name {
	color: #6196cc;
}

.token.boolean,
.token.number,
.token.function {
	color: #f08d49;
}

.token.property,
.token.class-name,
.token.constant,
.token.symbol {
	color: #f8c555;
}

.token.selector,
.token.important,
.token.atrule,
.token.keyword,
.token.builtin {
	color: #cc99cd;
}

.token.string,
.token.char,
.token.attr-value,
.token.regex,
.token.variable {
	color: #7ec699;
}

.token.operator,
.token.entity,
.token.url {
	color: #67cdcc;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

.token.inserted {
	color: green;
}
</style>


</head>

<body>

<p>:course<em>title: K8s</em>ADV_01 Istio</p>

<p>:course_desc: This course provides the student with the necessary steps to get a basic understanding of Istio.  </p>

<p>:course_max: 10</p>

<p>:course_auto: no</p>

<p>:button1_label: Task</p>

<p>:button2_label: Hint</p>

<p>:button2_delay: 999999</p>

<p>:button3_label: Complete</p>

<p>:button3_delay: 3000</p>

<p>:infotab: <hr></p>

<p>:infotab: <h1 id="toc_0">References</h1>
:infotab: <p><a href="https://istio.io/docs/tasks/">Istio.io</a></p>
:infotab: <h1 id="toc_1">License</h1>
:infotab: <p>This code pattern is licensed under the Apache Software License, Version 2.  Separate third party code objects invoked within this code pattern are licensed by their respective providers pursuant to their own separate licenses. Contributions are subject to the <a href="https://developercertificate.org/">Developer Certificate of Origin, Version 1.1 (DCO)</a> and the <a href="http://www.apache.org/licenses/LICENSE-2.0.txt">Apache Software License, Version 2</a>.</p>
:infotab: <p><a href="http://www.apache.org/foundation/license-faq.html#WhatDoesItMEAN">Apache Software License (ASL) FAQ</a></p></p>

<p>:infotab: <hr></p>

<hr>

<h4 id="toc_0">Task Introduction</h4>

<hr>

<h2 id="toc_1">ISTIO Introduction</h2>

<p>Microservices and containers changed application design and deployment patterns, but along with them brought challenges like service discovery, routing, failure handling, and visibility to microservices. &quot;Service mesh&quot; architecture was born to handle these features. Applications are getting decoupled internally as microservices, and the responsibility of maintaining coupling between these microservices is passed to the service mesh.</p>

<p><a href="https://istio.io/">Istio</a>, a joint collaboration between IBM, Google and Lyft provides an easy way to create a service mesh that will manage many of these complex tasks automatically, without the need to modify the microservices themselves. Istio does this by:</p>

<ol>
<li><p>Deploying a <strong>control plane</strong> that manages the overall network infrastructure and enforces the policy and traffic rules defined by the devops team</p></li>
<li><p>Deploying a <strong>data plane</strong> which includes “sidecars”, secondary containers that sit along side of each instance of a microservice and act as a proxy to intercept all incoming and outgoing network traffic. Sidecars are implemented using Envoy, an open source edge proxy</p></li>
</ol>

<p>Once Istio is installed some of the key feature which it makes available include</p>

<ul>
<li><p>Traffic management using <strong>Istio Pilot</strong>: In addition to providing content and policy based load balancing and routing, Pilot also maintains a canonical representation of services in the mesh.</p></li>
<li><p>Access control using <strong>Istio Auth</strong>: Istio Auth secures the service-to-service communication and also provides a key management system to manage keys and certificates.</p></li>
<li><p>Monitoring, reporting and quota management using <strong>Istio Mixer</strong>: Istio Mixer provides in depth monitoring and logs data collection for microservices, as well as collection of request traces. Precondition checking like whether the service consumer is on whitelist, quota management like rate limits etc. are also configured using Mixer.</p></li>
</ul>

<p>In the <a href="#part-a-deploy-sample-bookinfo-application-and-inject-istio-sidecars-to-enable-traffic-flow-management-access-policy-and-monitoring-data-aggregation-for-application">first part</a> of this journey we show how we can deploy the sample <a href="https://istio.io/docs/samples/bookinfo.html">BookInfo</a> application and inject sidecars to get the Istio features mentioned above, and walk through the key ones. The BookInfo is a simple application that is composed of four microservices, written in different languages for each of its microservices namely Python, Java, Ruby, and Node.js. The application does not use a database, and stores everything in local filesystem.</p>

<p>Also since Istio tightly controls traffic routing to provide above mentioned benefits, it introduces some drawbacks. Outgoing traffic to external services outside the Istio data plane can only be enabled by specialized configuration, based on the protocol used to connect to the external service.</p>

<p>In the <a href="#part-b-modify-sample-application-to-use-an-external-datasource-deploy-the-application-and-istio-envoys-with-egress-traffic-enabled">second part</a> of the journey we focus on how Istio can be configured to allow applications to connect to external services. For that we modify the sample BookInfo application to use an external database and then use it as a base to show Istio configuration for enabling egress traffic.</p>

<p><img src="https://raw.githubusercontent.com/niklaushirt/istio-introduction/master/images/istio-architecture.png" alt="istio-architecture"></p>

<h2 id="toc_2">Included Components</h2>

<ul>
<li><a href="https://istio.io/">Istio</a></li>
<li><a href="https://www.kiali.io/">Kiali</a></li>
<li><a href="http://docs.grafana.org/guides/getting_started">Grafana</a></li>
<li><a href="https://www.jaegertracing.io/">Jaeger</a></li>
<li><a href="https://prometheus.io/">Prometheus</a></li>
<li><a href="https://console.ng.bluemix.net/docs/containers/cs_ov.html#cs_ov">IBM Cloud Kubernetes Service</a></li>
</ul>

<hr>

<h1 id="toc_3">Course</h1>

<h3 id="toc_4">Beyond the Basics: Istio and IBM Cloud Kubernetes Service</h3>

<p>Istio is an open platform to connect, secure, control and observe microservices, also known as a service mesh, on cloud platforms such as Kubernetes in IBM Cloud Kubernetes Service and VMs. With Istio, You can manage network traffic, load balance across microservices, enforce access policies, verify service identity, secure service communication and observe what exactly is going on with your services.</p>

<p>In this course, you can see how to install Istio alongside microservices for a simple mock app called Guestbook. When you deploy Guestbook&#39;s microservices into an IBM Cloud Kubernetes Service cluster where Istio is installed, you can choose to inject the Istio Envoy sidecar proxies in the pods of certain microservices.</p>

<h3 id="toc_5">Objectives</h3>

<p>After you complete this course, you&#39;ll be able to: - Download and install Istio in your cluster - Deploy the Guestbook sample app - Use metrics, logging and tracing to observe services - Set up the Istio Ingress Gateway - Perform simple traffic management, such as A/B tests and canary deployments - Secure your service mesh - Enforce policies for your microservices</p>

<h3 id="toc_6">Workshop</h3>

<ul>
<li>Exercise 1 - Accessing a Kubernetes cluster with IBM Cloud Kubernetes Service</li>
<li>Exercise 2 - Installing Istio</li>
<li>Exercise 3 - Deploying Guestbook with Istio Proxy</li>
<li>Exercise 4 - Observe service telemetry: metrics and tracing</li>
<li>Exercise 5 - Expose the service mesh with the Istio Ingress Gateway</li>
<li>Exercise 6 - Perform traffic management</li>
<li>Exercise 7 - Secure your service mesh</li>
<li>Exercise 8 - Enforce policies for microservices</li>
</ul>

<hr>

<h4 id="toc_7">Hint Introduction</h4>

<p>No hint available</p>

<h4 id="toc_8">Complete Introduction</h4>

<blockquote>
<p>Confirm Introduction complete</p>
</blockquote>

<hr>

<h4 id="toc_9">Task Accessing a Kubernetes cluster</h4>

<hr>

<h1 id="toc_10">Exercise 1 - Accessing a Kubernetes cluster with IBM Cloud Kubernetes Service</h1>

<p>You must already have a <a href="https://console.bluemix.net/docs/containers/container_index.html#container_index">cluster created</a>. Here are the steps to access your cluster.</p>

<h2 id="toc_11">Install IBM Cloud Kubernetes Service command line utilities</h2>

<ol>
<li><p>Install the IBM Cloud <a href="https://console.bluemix.net/docs/cli/reference/bluemix_cli/get_started.html#getting-started">command line interface</a>.</p></li>
<li><p>Log in to the IBM Cloud CLI.</p>

<div><pre><code class="language-shell">ibmcloud login</code></pre></div>

<p>If you have a federated account, include the <code>--sso</code> flag.</p>

<div><pre><code class="language-shell">ibmcloud login --sso</code></pre></div>

<p>If you have an api key, use:</p>

<div><pre><code class="language-shell">ibmcloud login --apikey &lt;apikey&gt;</code></pre></div></li>
<li><p>Install the IBM Cloud Kubernetes Service plug-in.</p>

<div><pre><code class="language-shell">ibmcloud plugin install container-service</code></pre></div></li>
<li><p>To verify that the plug-in is installed properly, run <code>ibmcloud plugin list</code>. The Container Service plug-in is displayed in the results as <code>container-service/kubernetes-service</code>.</p></li>
<li><p>Initialize the Container Service plug-in and point the endpoint to your region. For example when prompted, enter <code>5</code> for <code>us-east</code>.</p>

<p>Example:</p>

<div><pre><code class="language-shell">ibmcloud ks region-set
Choose a region:
1. ap-north
2. ap-south
3. eu-central
4. uk-south
5. us-east
6. us-south
Enter a number&gt; 5</code></pre></div></li>
<li><p>Install the <code>kubectl</code> Kubernetes CLI. Go to the <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-via-curl">Kubernetes page</a>, and follow the steps to install the CLI.</p></li>
</ol>

<h2 id="toc_12">Access your cluster</h2>

<p>Learn how to set the context to work with your cluster by using the <code>kubectl</code> CLI, access the Kubernetes dashboard, and gather basic information about your cluster.</p>

<ol>
<li><p>Set the context for your cluster in your CLI. Every time you log in to the IBM Cloud Kubernetes Service CLI to work with the cluster, you must run these commands to set the path to the cluster&#39;s configuration file as a session variable. The Kubernetes CLI uses this variable to find a local configuration file and certificates that are necessary to connect with the cluster in IBM Cloud.</p>

<p>a. List the available clusters.</p>

<div><pre><code class="language-shell">ibmcloud ks clusters</code></pre></div>

<p>b. Download the configuration file and certificates for your cluster using the <code>cluster-config</code> command.</p>

<div><pre><code class="language-shell">ibmcloud ks cluster-config &lt;your_cluster_name&gt;</code></pre></div>

<p>c. Copy and paste the output command from the previous step to set the <code>KUBECONFIG</code> environment variable and configure your CLI to run <code>kubectl</code> commands against your cluster.</p>

<p>Example:
<code>shell
export KUBECONFIG=/Users/user-name/.bluemix/plugins/container-service/clusters/mycluster/kube-config-hou02-mycluster.yml
</code></p></li>
<li><p>Get basic information about your cluster and its worker nodes. This information can help you manage your cluster and troubleshoot issues.</p>

<p>a.  View details of your cluster.</p>

<div><pre><code class="language-shell">ibmcloud ks cluster-get &lt;your_cluster_name&gt;</code></pre></div>

<p>b.  Verify the worker nodes in the cluster.</p>

<div><pre><code class="language-shell">ibmcloud ks workers &lt;your_cluster_name&gt;
ibmcloud ks worker-get &lt;worker_ID&gt;</code></pre></div></li>
<li><p>Validate access to your cluster.</p>

<p>a.  View nodes in the cluster.</p>

<div><pre><code class="language-shell">kubectl get node</code></pre></div>

<p>b.  View services, deployments, and pods.</p>

<div><pre><code class="language-shell">kubectl get svc,deploy,po --all-namespaces</code></pre></div></li>
</ol>

<h2 id="toc_13">Clone the lab repo</h2>

<ol>
<li><p>From your command line, run:</p>

<div><pre><code class="language-shell">git clone https://github.com/IBM/istio101

cd istio101/workshop</code></pre></div>

<p>This is the working directory for the workshop. You will use the example <code>.yaml</code> files that are located in the <code>workshop/plans</code> directory in the following exercises.</p></li>
</ol>

<h4 id="toc_14">Hint Accessing a Kubernetes cluster</h4>

<p>No hint available</p>

<h4 id="toc_15">Complete Accessing a Kubernetes cluster</h4>

<blockquote>
<p>Confirm Accessing a Kubernetes cluster complete</p>
</blockquote>

<h4 id="toc_16">Task Installing Istio</h4>

<hr>

<h1 id="toc_17">Exercise 2 - Installing Istio on IBM Cloud Kubernetes Service</h1>

<p>In this module, you download and install Istio.</p>

<ol>
<li><p>Either download Istio directly from <a href="https://github.com/istio/istio/releases">https://github.com/istio/istio/releases</a> or get the latest version by using curl:</p>

<div><pre><code class="language-shell">curl -L https://git.io/getLatestIstio | sh -</code></pre></div></li>
<li><p>Change the directory to the Istio file location.</p>

<div><pre><code class="language-shell">cd istio-&lt;version-number&gt;</code></pre></div></li>
<li><p>Add the <code>istioctl</code> client to your PATH. </p>

<div><pre><code class="language-shell">export PATH=$PWD/bin:$PATH</code></pre></div></li>
<li><p>Install Istio’s Custom Resource Definitions via kubectl apply, and wait a few seconds for the CRDs to be committed in the kube-apiserver:</p>

<div><pre><code class="language-shell">for i in install/kubernetes/helm/istio-init/files/crd*yaml; do kubectl apply -f $i; done</code></pre></div></li>
<li><p>Now let&#39;s install Istio demo profile into the <code>istio-system</code> namespace in your Kubernetes cluster:</p>

<div><pre><code class="language-shell">kubectl apply -f install/kubernetes/istio-demo.yaml</code></pre></div></li>
<li><p>Ensure that the <code>istio-*</code> Kubernetes services are deployed before you continue.</p>

<div><pre><code class="language-shell">kubectl get svc -n istio-system</code></pre></div>

<p>Sample output:
<code>shell
NAME                     TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)                                                                                                                                      AGE
grafana                  ClusterIP      172.21.135.33    &lt;none&gt;           3000/TCP                                                                                                                                     35s
istio-citadel            ClusterIP      172.21.242.77    &lt;none&gt;           8060/TCP,15014/TCP                                                                                                                           34s
istio-egressgateway      ClusterIP      172.21.20.200    &lt;none&gt;           80/TCP,443/TCP,15443/TCP                                                                                                                     35s
istio-galley             ClusterIP      172.21.246.214   &lt;none&gt;           443/TCP,15014/TCP,9901/TCP                                                                                                                   36s
istio-ingressgateway     LoadBalancer   172.21.151.128   169.60.168.234   80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:32268/TCP,15030:30743/TCP,15031:32200/TCP,15032:31341/TCP,15443:31059/TCP,15020:31039/TCP   35s
istio-pilot              ClusterIP      172.21.243.70    &lt;none&gt;           15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       34s
istio-policy             ClusterIP      172.21.144.137   &lt;none&gt;           9091/TCP,15004/TCP,15014/TCP                                                                                                                 34s
istio-sidecar-injector   ClusterIP      172.21.230.192   &lt;none&gt;           443/TCP                                                                                                                                      33s
istio-telemetry          ClusterIP      172.21.213.11    &lt;none&gt;           9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       34s
jaeger-agent             ClusterIP      None             &lt;none&gt;           5775/UDP,6831/UDP,6832/UDP                                                                                                                   29s
jaeger-collector         ClusterIP      172.21.187.128   &lt;none&gt;           14267/TCP,14268/TCP                                                                                                                          29s
jaeger-query             ClusterIP      172.21.89.210    &lt;none&gt;           16686/TCP                                                                                                                                    30s
kiali                    ClusterIP      172.21.219.101   &lt;none&gt;           20001/TCP                                                                                                                                    35s
prometheus               ClusterIP      172.21.53.185    &lt;none&gt;           9090/TCP                                                                                                                                     34s
tracing                  ClusterIP      172.21.6.64      &lt;none&gt;           80/TCP                                                                                                                                       29s
zipkin                   ClusterIP      172.21.229.37    &lt;none&gt;           9411/TCP                                                                                                                                     29s
</code></p></li>
</ol>

<p><strong>Note: If your istio-ingressgateway service IP is <pending>, confirm that you are using a standard/paid cluster. Free cluster is not supported for this lab.</strong></p>

<ol>
<li><p>Ensure the corresponding pods <code>istio-citadel-*</code>, <code>istio-ingressgateway-*</code>, <code>istio-pilot-*</code>, and <code>istio-policy-*</code> are all in <strong><code>Running</code></strong> state before you continue.</p>

<div><pre><code class="language-shell">kubectl get pods -n istio-system</code></pre></div>

<p>Sample output:
<code>shell
NAME                                      READY   STATUS      RESTARTS   AGE
grafana-5c45779547-v77cl                  1/1     Running     0          103s
istio-citadel-79cb95445b-29wvj            1/1     Running     0          102s
istio-cleanup-secrets-1.1.0-mp6qq         0/1     Completed   0          112s
istio-egressgateway-6dfb8dd765-jzzxf      1/1     Running     0          104s
istio-galley-7bccb97448-tk8bz             1/1     Running     0          104s
istio-grafana-post-install-1.1.0-bvng6    0/1     Completed   0          113s
istio-ingressgateway-679bd59c6-5bsbr      1/1     Running     0          104s
istio-pilot-674d4b8469-ttxs8              2/2     Running     0          103s
istio-policy-6b8795b6b5-g5m2k             2/2     Running     2          103s
istio-security-post-install-1.1.0-cfqpx   0/1     Completed   0          111s
istio-sidecar-injector-646d77f96c-55twm   1/1     Running     0          102s
istio-telemetry-76c8fbc99f-hxskk          2/2     Running     2          103s
istio-tracing-5fbc94c494-5nkjd            1/1     Running     0          102s
kiali-56d95cf466-bpgfq                    1/1     Running     0          103s
prometheus-8647cf4bc7-qnp6x               1/1     Running     0          102s
</code></p>

<p>Before you continue, make sure all the pods are deployed and are either in the <strong><code>Running</code></strong> or <strong><code>Completed</code></strong> state. If they&#39;re in <code>pending</code> state, wait a few minutes to let the deployment finish.</p>

<p>Congratulations! You successfully installed Istio into your cluster.</p></li>
</ol>

<h4 id="toc_18">Hint Installing Istio</h4>

<p>No hint available</p>

<h4 id="toc_19">Complete Installing Istio</h4>

<blockquote>
<p>Confirm Installing Istio complete</p>
</blockquote>

<h4 id="toc_20">Task Deploy the Guestbook app</h4>

<hr>

<h1 id="toc_21">Exercise 3 - Deploy the Guestbook app with Istio Proxy</h1>

<p>The Guestbook app is a sample app for users to leave comments. It consists of a web front end, Redis master for storage, and a replicated set of Redis slaves. We will also integrate the app with Watson Tone Analyzer which detects the sentiment in users&#39; comments and replies with emoticons.</p>

<h3 id="toc_22">Download the Guestbook app</h3>

<ol>
<li><p>Clone the Guestbook app into the <code>workshop</code> directory.</p>

<div><pre><code class="language-shell">git clone https://github.com/IBM/guestbook.git ../guestbook</code></pre></div></li>
<li><p>Navigate into the app directory.</p>

<div><pre><code class="language-shell">cd ../guestbook/v2</code></pre></div></li>
</ol>

<h3 id="toc_23">Create a Redis database</h3>

<p>The Redis database is a service that you can use to persist the data of your app. The Redis database comes with a master and slave modules.</p>

<ol>
<li><p>Create the Redis controllers and services for both the master and the slave.</p>

<div><pre><code class="language-shell">kubectl create -f redis-master-deployment.yaml
kubectl create -f redis-master-service.yaml
kubectl create -f redis-slave-deployment.yaml
kubectl create -f redis-slave-service.yaml</code></pre></div></li>
<li><p>Verify that the Redis controllers for the master and the slave are created.</p>

<div><pre><code class="language-shell">kubectl get deployment</code></pre></div>

<p>Output:
<code>shell
NAME           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
redis-master   1         1         1            1           5d
redis-slave    2         2         2            2           5d
</code></p></li>
<li><p>Verify that the Redis services for the master and the slave are created.</p>

<div><pre><code class="language-shell">kubectl get svc</code></pre></div>

<p>Output:
<code>shell
NAME           TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE
redis-master   ClusterIP      172.21.85.39    &lt;none&gt;          6379/TCP       5d
redis-slave    ClusterIP      172.21.205.35   &lt;none&gt;          6379/TCP       5d
</code></p></li>
<li><p>Verify that the Redis pods for the master and the slave are up and running.</p>

<div><pre><code class="language-shell">kubectl get pods</code></pre></div>

<p>Output:
<code>shell
NAME                            READY     STATUS    RESTARTS   AGE
redis-master-4sswq              1/1       Running   0          5d
redis-slave-kj8jp               1/1       Running   0          5d
redis-slave-nslps               1/1       Running   0          5d
</code></p></li>
</ol>

<h2 id="toc_24">Sidecar injection</h2>

<p>In Kubernetes, a sidecar is a utility container in the pod, and its purpose is to support the main container. For Istio to work, Envoy proxies must be deployed as sidecars to each pod of the deployment. There are two ways of injecting the Istio sidecar into a pod: manually using the istioctl CLI tool or automatically using the Istio Initializer. In this exercise, we will use the manual injection. Manual injection modifies the controller configuration, e.g. deployment. It does this by modifying the pod template spec such that all pods for that deployment are created with the injected sidecar.</p>

<h2 id="toc_25">Install the Guestbook app with manual sidecar injection</h2>

<ol>
<li><p>Inject the Istio Envoy sidecar into the guestbook pods, and deploy the Guestbook app on to the Kubernetes cluster. Deploy both the v1 and v2 versions of the app:</p>

<div><pre><code class="language-shell">kubectl apply -f &lt;(istioctl kube-inject -f ../v1/guestbook-deployment.yaml)
kubectl apply -f &lt;(istioctl kube-inject -f guestbook-deployment.yaml)</code></pre></div></li>
</ol>

<p>These commands will inject the Istio Envoy sidecar into the guestbook pods, as well as deploy the Guestbook app on to the Kubernetes cluster. Here we have two versions of deployments, a new version (<code>v2</code>) in the current directory, and a previous version (<code>v1</code>) in a sibling directory. They will be used in future sections to showcase the Istio traffic routing capabilities.</p>

<ol>
<li><p>Create the guestbook service.</p>

<div><pre><code class="language-shell">kubectl create -f guestbook-service.yaml</code></pre></div></li>
<li><p>Verify that the service was created.</p>

<div><pre><code class="language-shell">kubectl get svc</code></pre></div>

<p>Output:
<code>shell
NAME           TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE
guestbook      LoadBalancer   172.21.36.181   169.61.37.140   80:32149/TCP   5d
</code></p></li>
<li><p>Verify that the pods are up and running.</p>

<div><pre><code class="language-shell">kubectl get pods</code></pre></div>

<p>Output:
<code>shell
NAME                            READY     STATUS    RESTARTS   AGE
guestbook-v1-89cd4b7c7-frscs    2/2       Running   0          5d
guestbook-v1-89cd4b7c7-jn224    2/2       Running   0          5d
guestbook-v1-89cd4b7c7-m7hmd    2/2       Running   0          5d
guestbook-v2-56d98b558c-7fvd5   2/2       Running   0          5d
guestbook-v2-56d98b558c-dshkh   2/2       Running   0          5d
guestbook-v2-56d98b558c-mzbxk   2/2       Running   0          5d
</code></p>

<p>Note that each guestbook pod has 2 containers in it. One is the guestbook container, and the other is the Envoy proxy sidecar.</p></li>
</ol>

<h3 id="toc_26">Use Watson Tone Analyzer</h3>

<p>Watson Tone Analyzer detects the tone from the words that users enter into the Guestbook app. The tone is converted to the corresponding emoticons.</p>

<ol>
<li><p>Create Watson Tone Analyzer in your account.</p>

<div><pre><code class="language-shell">ibmcloud resource service-instance-create my-tone-analyzer-service tone-analyzer lite us-south</code></pre></div></li>
<li><p>Create the service key for the Tone Analyzer service. This command should output the credentials you just created. You will need the value for <strong>apikey</strong> &amp; <strong>url</strong> later.</p>

<div><pre><code class="language-shell">ibmcloud resource service-key-create tone-analyzer-key Manager --instance-name my-tone-analyzer-service</code></pre></div></li>
<li><p>If you need to get the service-keys later, you can use the following command:</p>

<div><pre><code class="language-shell">ibmcloud resource service-key tone-analyzer-key</code></pre></div></li>
<li><p>Open the <code>analyzer-deployment.yaml</code> and find the env section near the end of the file. Replace <code>YOUR_API_KEY</code> with your own API key, and replace <code>YOUR_URL</code> with the url value you saved before. YOUR_URL should look something like <code>https://gateway.watsonplatform.net/tone-analyzer/api</code>. Save the file.</p></li>
<li><p>Deploy the analyzer pods and service, using the <code>analyzer-deployment.yaml</code> and <code>analyzer-service.yaml</code> files found in the <code>guestbook/v2</code> directory. The analyzer service talks to Watson Tone Analyzer to help analyze the tone of a message.</p>

<div><pre><code class="language-shell">kubectl apply -f &lt;(istioctl kube-inject -f analyzer-deployment.yaml)
kubectl apply -f analyzer-service.yaml</code></pre></div></li>
</ol>

<p>Great! Your guestbook app is up and running. In Exercise 4, you&#39;ll be able to see the app in action by directly accessing the service endpoint. You&#39;ll also be able to view Telemetry data for the app.</p>

<h4 id="toc_27">Hint Deploy the Guestbook app</h4>

<p>No hint available</p>

<h4 id="toc_28">Complete Deploy the Guestbook app</h4>

<blockquote>
<p>Confirm aa complete</p>
</blockquote>

<h4 id="toc_29">Task Observe service telemetry</h4>

<hr>

<h1 id="toc_30">Exercise 4 - Observe service telemetry: metrics and tracing</h1>

<h3 id="toc_31">Challenges with microservices</h3>

<p>We all know that microservice architecture is the perfect fit for cloud native applications and it increases the delivery velocities greatly. Envision you have many microservices that are delivered by multiple teams, how do you observe the the overall platform and each of the service to find out exactly what is going on with each of the services?  When something goes wrong, how do you know which service or which communication among the few services are causing the problem?</p>

<h3 id="toc_32">Istio telemetry</h3>

<p>Istio&#39;s tracing and metrics features are designed to provide broad and granular insight into the health of all services. Istio&#39;s role as a service mesh makes it the ideal data source for observability information, particularly in a microservices environment. As requests pass through multiple services, identifying performance bottlenecks becomes increasingly difficult using traditional debugging techniques. Distributed tracing provides a holistic view of requests transiting through multiple services, allowing for immediate identification of latency issues. With Istio, distributed tracing comes by default. This will expose latency, retry, and failure information for each hop in a request.</p>

<p>You can read more about how <a href="https://istio.io/docs/concepts/policy-and-control/mixer.html">Istio mixer enables telemetry reporting</a>.</p>

<h3 id="toc_33">Configure Istio to receive telemetry data</h3>

<ol>
<li><p>Verify that the Grafana, Prometheus, ServiceGraph and Jaeger add-ons were installed successfully. All add-ons are installed into the <code>istio-system</code> namespace.</p>

<div><pre><code class="language-shell">kubectl get pods -n istio-system
kubectl get services -n istio-system</code></pre></div></li>
<li><p>Configure Istio to automatically gather telemetry data for services that run in the service mesh. Create a rule to collect telemetry data.
<code>shell
cd ../../plans/
kubectl create -f guestbook-telemetry.yaml
</code></p></li>
<li><p>Obtain the guestbook endpoint to access the guestbook. You can access the guestbook via the external IP for your service as guestbook is deployed as a load balancer service. Get the EXTERNAL-IP of the guestbook service via output below:</p>

<div><pre><code class="language-shell">kubectl get service guestbook -n default</code></pre></div></li>
</ol>

<p>Go to this external ip address in the browser to try out your guestbook.</p>

<ol>
<li><p>Generate a small load to the app.</p>

<div><pre><code class="language-shell">for i in {1..20}; do sleep 0.5; curl http://&lt;guestbook_IP&gt;/; done</code></pre></div></li>
</ol>

<h2 id="toc_34">View guestbook telemetry data</h2>

<h4 id="toc_35">Jaeger</h4>

<ol>
<li><p>Establish port forwarding from local port 16686 to the Tracing instance:</p>

<div><pre><code class="language-shell">kubectl port-forward -n istio-system \
  $(kubectl get pod -n istio-system -l app=jaeger -o jsonpath=&#39;{.items[0].metadata.name}&#39;) \
  16686:16686 &amp;</code></pre></div></li>
<li><p>In your browser, go to <code>http://127.0.0.1:16686</code></p></li>
<li><p>From the <strong>Services</strong> menu, select either the <strong>guestbook</strong> or <strong>analyzer</strong> service.</p></li>
<li><p>Scroll to the bottom and click on <strong>Find Traces</strong> button to see traces.</p></li>
</ol>

<p>Read more about <a href="https://www.jaegertracing.io/docs/">Jaeger</a></p>

<h4 id="toc_36">Grafana</h4>

<ol>
<li><p>Establish port forwarding from local port 3000 to the Grafana instance:</p>

<div><pre><code class="language-shell">kubectl -n istio-system port-forward \
  $(kubectl -n istio-system get pod -l app=grafana -o jsonpath=&#39;{.items[0].metadata.name}&#39;) \
  3000:3000 &amp;</code></pre></div></li>
<li><p>Browse to http://localhost:3000 and navigate to the <code>Istio Service Dashboard</code> by clicking on the Home menu on the top left, then Istio, then Istio Service Dashboard.</p></li>
<li><p>Select guestbook in the Service drop down.</p></li>
<li><p>In a different tab, visit the guestbook application and refresh the page multiple times to generate some load, or run the load script you used previously. Switch back to the Grafana tab.</p></li>
</ol>

<p>This Grafana dashboard provides metrics for each workload. Explore the other dashboard provided as well. </p>

<p>Read more about <a href="http://docs.grafana.org/">Grafana</a>.</p>

<h4 id="toc_37">Prometheus</h4>

<ol>
<li><p>Establish port forwarding from local port 9090 to the Prometheus instance.</p>

<div><pre><code class="language-shell">kubectl -n istio-system port-forward \
  $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath=&#39;{.items[0].metadata.name}&#39;) \
  9090:9090 &amp;</code></pre></div></li>
<li><p>Browse to http://localhost:9090/graph, and in the “Expression” input box, enter: <code>istio_request_bytes_count</code>. Click Execute and then select Graph.</p></li>
<li><p>Then try another query: <code>istio_requests_total{destination_service=&quot;guestbook.default.svc.cluster.local&quot;, destination_version=&quot;2.0&quot;}</code></p></li>
</ol>

<h4 id="toc_38">Kiali</h4>

<p>Kiali is an open-source project that installs on top of Istio to visualize your service mesh. It provides deeper insight into how your microservices interact with one another, and provides features such as circuit breakers and request rates for your services</p>

<ol>
<li><p>Establish port forwarding from local port 20001 to the Kiali instance.</p>

<div><pre><code class="language-shell">kubectl -n istio-system port-forward \
$(kubectl -n istio-system get pod -l app=kiali -o jsonpath=&#39;{.items[0].metadata.name}&#39;) \
20001:20001 &amp;</code></pre></div></li>
<li><p>Browse to <a href="http://localhost:20001/kiali/">http://localhost:20001/kiali/</a>, and login with <code>admin</code> for both username and password.</p></li>
<li><p>Select Graph and then choose <code>default</code> namespace. You should see a visual service graph of the various services in your Istio mesh.</p></li>
<li><p>Use the <code>Edge Labels</code> dropdown and select <code>Traffic rate per second</code> to see the request rates as well.</p></li>
<li><p>Kiali has a number of views to help you visualize your services. Click through the vairous tabs to explore the service graph, and the various views for workloads, applications, and services.</p></li>
</ol>

<h2 id="toc_39">Understand what happened</h2>

<p>Although Istio proxies are able to automatically send spans, they need some hints to tie together the entire trace. Apps need to propagate the appropriate HTTP headers so that when the proxies send span information to Zipkin or Jaeger, the spans can be correlated correctly into a single trace.</p>

<p>In the example, when a user visits the Guestbook app, the HTTP request is sent from the guestbook service to Watson Tone Analyzer. In order for the individual spans of guestbook service and Watson Tone Analyzer to be tied together, we have modified the guestbook service to extract the required headers (x-request-id, x-b3-traceid, x-b3-spanid, x-b3-parentspanid, x-b3-sampled, x-b3-flags, x-ot-span-context) and forward them onto the analyzer service when calling the analyzer service from the guestbook service. The change is in the <code>v2/guestbook/main.go</code>. By using the <code>getForwardHeaders()</code> method, we are able to extract the required headers, and then we use the required headers further when calling the analyzer service via the <code>getPrimaryTone()</code> method.</p>

<h2 id="toc_40">Questions</h2>

<ol>
<li><p>Does a user need to modify their app to get metrics for their apps?   A: 1. Yes 2. No. (2 is correct)</p></li>
<li><p>Does a user need to modify their app to get distributed tracing for their app to work properly? A: 1. Yes 2. No. (1 is correct)</p></li>
<li><p>What distributed tracing system does Istio support by default?  A: 1. Zipkin 2. Kibana 3. LogStash 4. Jaeger. (1 and 4 are correct)</p></li>
</ol>

<h4 id="toc_41">Hint Observe service telemetry</h4>

<p>No hint available</p>

<h4 id="toc_42">Complete Observe service telemetry</h4>

<blockquote>
<p>Confirm Observe service telemetry complete</p>
</blockquote>

<h4 id="toc_43">Task Expose the service mesh</h4>

<hr>

<h1 id="toc_44">Exercise 5 - Expose the service mesh with the Istio Ingress Gateway</h1>

<p>The components deployed on the service mesh by default are not exposed outside the cluster. External access to individual services so far has been provided by creating an external load balancer or node port on each service.</p>

<p>An Ingress Gateway resource can be created to allow external requests through the Istio Ingress Gateway to the backing services.</p>

<h3 id="toc_45">Expose the Guestbook app with Ingress Gateway</h3>

<ol>
<li>Configure the guestbook default route with the Istio Ingress Gateway. The <code>guestbook-gateway.yaml</code> file is in this repository (istio101) in the <code>workshop/plans</code> directory.</li>
</ol>

<div><pre><code class="language-shell">kubectl create -f guestbook-gateway.yaml</code></pre></div>

<ol>
<li>Get the <strong>EXTERNAL-IP</strong> of the Istio Ingress Gateway.</li>
</ol>

<div><pre><code class="language-shell">kubectl get service istio-ingressgateway -n istio-system</code></pre></div>

<p>Output:
<code>shell
NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                                       AGE
istio-ingressgateway   LoadBalancer   172.21.254.53    169.6.1.1       80:31380/TCP,443:31390/TCP,31400:31400/TCP    1m
2d
</code></p>

<ol>
<li>Make note of the external IP address that you retrieved in the previous step, as it will be used to access the Guestbook app in later parts of the course. You can create an environment variable called $INGRESS_IP with your IP address.</li>
</ol>

<p>Example:
<code>
export INGRESS_IP=169.6.1.1
</code></p>

<h2 id="toc_46">Connect Istio Ingress Gateway to the IBM Cloud Kubernetes Service Provided Domain Name</h2>

<p>Standard IBM Cloud Kubernetes Clusters can expose applications deployed within your cluster using a Kubernetes Ingress application load balancer (ALB). IBM Cloud Kubernetes Service automatically creates a highly available ALB for your cluster and assigns a unique public route to it in the format: <cluster_name>.<region_or_zone>.containers.appdomain.cloud.</p>

<p>The Ingress resource provides IBM Cloud users with a secure, reliable, and scalable network stack to distribute incoming network traffic to apps in IBM Cloud. You can enhance the IBM-provided Ingress application load balancer by adding annotations. Learn more about <a href="https://console.bluemix.net/docs/containers/cs_ingress.html#ingress">Ingress for IBM Cloud Kubernetes Service</a>.</p>

<p>To use this IBM provided DNS for the Guestbook app, you must set the Kubernetes Ingress application load balancer (ALB) to route traffic to the Istio Ingress Gateway.</p>

<ol>
<li><p>Let&#39;s first check the IBM Ingress subdomain information.</p>

<div><pre><code class="language-shell">ibmcloud ks cluster-get &lt;cluster_name&gt;</code></pre></div>

<p>Output:
<code>shell
Ingress subdomain:  mycluster.us-east.containers.appdomain.cloud
</code></p></li>
<li><p>Prepend <code>guestbook.</code> to the subdomain that you retrieved in the previous step. This new url will serve as <code>host</code> in the <code>guestbook-frontdoor.yaml</code> file, which you can find and edit in the <code>istio101/workshop/plans</code> directory.</p>

<p>The file should now look something like this:</p>

<div><pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: guestbook-ingress
  namespace: istio-system
spec:
  rules:
    - host: guestbook.mycluster.us-east.containers.appdomain.cloud
      http:
        paths:
          - path: /
            backend:
              serviceName: istio-ingressgateway
              servicePort: 80</code></pre></div></li>
<li><p>Create the Ingress with the IBM-provided subdomain.</p>

<div><pre><code class="language-shell">kubectl apply -f guestbook-frontdoor.yaml</code></pre></div></li>
<li><p>List the details for your Ingress.</p>

<div><pre><code class="language-shell">kubectl get ingress guestbook-ingress -n istio-system</code></pre></div>

<p>Example output:
<code>
NAME                HOSTS                                                          ADDRESS          PORTS   AGE
guestbook-ingress   guestbook.mycluster.us-south.containers.appdomain.cloud   169.60.168.238   80      6s
</code></p></li>
<li><p>Make note of the IBM-provided subdomain as it will be used to access your Guestbook app in later parts of the course.</p>

<p>Example:
<code>
http://guestbook.mycluster.us-south.containers.appdomain.cloud
</code></p></li>
</ol>

<p>Congratulations! You extended the base Ingress features by providing a DNS entry to the Istio service.</p>

<h2 id="toc_47">References:</h2>

<p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Kubernetes Ingress</a>
<a href="https://istio.io/docs/tasks/traffic-management/ingress.html">Istio Ingress</a></p>

<h4 id="toc_48">Hint Expose the service mesh</h4>

<p>No hint available</p>

<h4 id="toc_49">Complete Expose the service mesh</h4>

<blockquote>
<p>Confirm Expose the service mesh complete</p>
</blockquote>

<h4 id="toc_50">Task Perform traffic management</h4>

<hr>

<h1 id="toc_51">Exercise 6 - Perform traffic management</h1>

<h2 id="toc_52">Using rules to manage traffic</h2>

<p>The core component used for traffic management in Istio is Pilot, which manages and configures all the Envoy proxy instances deployed in a particular Istio service mesh. It lets you specify what rules you want to use to route traffic between Envoy proxies, which run as sidecars to each service in the mesh. Each service consists of any number of instances running on pods, containers, VMs etc. Each service can have any number of versions (a.k.a. subsets). There can be distinct subsets of service instances running different variants of the app binary. These variants are not necessarily different API versions. They could be iterative changes to the same service, deployed in different environments (prod, staging, dev, etc.). Pilot translates high-level rules into low-level configurations and distributes this config to Envoy instances. Pilot uses three types of configuration resources to manage traffic within its service mesh: Virtual Services, Destination Rules, and Service Entries.</p>

<h3 id="toc_53">Virtual Services</h3>

<p>A <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#VirtualService">VirtualService</a> defines a set of traffic routing rules to apply when a host is addressed. Each routing rule defines matching criteria for traffic of a specific protocol. If the traffic is matched, then it is sent to a named <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3.html#Destination">destination</a> service (or <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#Subset">subset</a> or version of it) defined in the service registry.</p>

<h3 id="toc_54">Destination Rules</h3>

<p>A <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#Destination">DestinationRule</a> defines policies that apply to traffic intended for a service after routing has occurred. These rules specify configuration for load balancing, connection pool size from the sidecar, and outlier detection settings to detect and evict unhealthy hosts from the load balancing pool. Any destination <code>host</code> and <code>subset</code> referenced in a <code>VirtualService</code> rule must be defined in a corresponding <code>DestinationRule</code>.</p>

<h3 id="toc_55">Service Entries</h3>

<p>A <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3.html#ServiceEntry">ServiceEntry</a> configuration enables services within the mesh to access a service not necessarily managed by Istio. The rule describes the endpoints, ports and protocols of a white-listed set of mesh-external domains and IP blocks that services in the mesh are allowed to access.</p>

<h2 id="toc_56">The Guestbook app</h2>

<p>In the Guestbook app, there is one service: guestbook. The guestbook service has two distinct versions: the base version (version 1) and the modernized version (version 2). Each version of the service has three instances based on the number of replicas in <a href="https://github.com/linsun/examples/blob/master/guestbook-go/guestbook-deployment.yaml">guestbook-deployment.yaml</a> and <a href="https://github.com/linsun/examples/blob/master/guestbook-go/guestbook-v2-deployment.yaml">guestbook-v2-deployment.yaml</a>. By default, prior to creating any rules, Istio will route requests equally across version 1 and version 2 of the guestbook service and their respective instances in a round robin manner. However, new versions of a service can easily introduce bugs to the service mesh, so following A/B Testing and Canary Deployments is good practice.</p>

<h3 id="toc_57">A/B testing with Istio</h3>

<p>A/B testing is a method of performing identical tests against two separate service versions in order to determine which performs better. To prevent Istio from performing the default routing behavior between the original and modernized guestbook service, define the following rules (found in <a href="https://github.com/IBM/istio101/tree/master/workshop/plans">istio101/workshop/plans</a>):</p>

<div><pre><code class="language-shell">kubectl create -f guestbook-destination.yaml</code></pre></div>

<p>Let&#39;s examine the rule:
<code>yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: destination-guestbook
spec:
  host: guestbook
  subsets:
    - name: v1
      labels:
        version: &#39;1.0&#39;
    - name: v2
      labels:
        version: &#39;2.0&#39;
</code></p>

<div><pre><code class="language-shell">kubectl replace -f virtualservice-all-v1.yaml</code></pre></div>

<p>Let&#39;s examine the rule:
<code>yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: virtual-service-guestbook
spec:
  hosts:
    - &#39;*&#39;
  gateways:
    - guestbook-gateway
  http:
    - route:
        - destination:
            host: guestbook
            subset: v1
</code></p>

<p>The <code>VirtualService</code> defines a rule that captures all HTTP traffic coming in through the Istio ingress gateway, <code>guestbook-gateway</code>, and routes 100% of the traffic to pods of the guestbook service with label &quot;version: v1&quot;. A subset or version of a route destination is identified with a reference to a named service subset which must be declared in a corresponding <code>DestinationRule</code>. Since there are three instances matching the criteria of hostname <code>guestbook</code> and subset <code>version: v1</code>, by default Envoy will send traffic to all three instances in a round robin manner. You can view the guestbook service UI using the IP address and port obtained in <a href="../exercise-5/README.md">Exercise 5</a> and enter it as a URL in Firefox or Chrome web browsers.</p>

<p>To enable the Istio service mesh for A/B testing against the new service version, modify the original <code>VirtualService</code> rule:</p>

<div><pre><code class="language-shell">kubectl replace -f virtualservice-test.yaml</code></pre></div>

<p>Let&#39;s examine the rule:
<code>yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: virtual-service-guestbook
spec:
  hosts:
    - &#39;*&#39;
  gateways:
    - guestbook-gateway
  http:
    - match:
        - headers:
            user-agent:
              regex: &#39;.*Firefox.*&#39;
      route:
        - destination:
            host: guestbook
            subset: v2
    - route:
        - destination:
            host: guestbook
            subset: v1
</code></p>

<p>In Istio <code>VirtualService</code> rules, there can be only one rule for each service and therefore when defining multiple <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#HTTPRoute">HTTPRoute</a> blocks, the order in which they are defined in the yaml matters. Hence, the original <code>VirtualService</code> rule is modified rather than creating a new rule. With the modified rule, incoming requests originating from <code>Firefox</code> browsers will go to the newer version of guestbook. All other requests fall-through to the next block, which routes all traffic to the original version of guestbook.</p>

<h3 id="toc_58">Canary deployment</h3>

<p>In <code>Canary Deployments</code>, newer versions of services are incrementally rolled out to users to minimize the risk and impact of any bugs introduced by the newer version. To begin incrementally routing traffic to the newer version of the guestbook service, modify the original <code>VirtualService</code> rule:</p>

<div><pre><code class="language-shell">kubectl replace -f virtualservice-80-20.yaml</code></pre></div>

<p>Let&#39;s examine the rule:
<code>yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: virtual-service-guestbook
spec:
  hosts:
    - &#39;*&#39;
  gateways:
    - guestbook-gateway
  http:
    - route:
        - destination:
            host: guestbook
            subset: v1
          weight: 80
        - destination:
            host: guestbook
            subset: v2
          weight: 20
</code></p>

<p>In the modified rule, the routed traffic is split between two different subsets of the guestbook service. In this manner, traffic to the modernized version 2 of guestbook is controlled on a percentage basis to limit the impact of any unforeseen bugs. This rule can be modified over time until eventually all traffic is directed to the newer version of the service.</p>

<p>You can see this in action by going to the ingress ip address (that you saved in exercise 5) in your browser. Ensure that you are using a hard refresh (command + Shift + R on Mac or Ctrl + F5 on windows) to remove any browser caching. You should notice that the guestbook should swap between V1 or V2 at about the weight you specified.</p>

<p>If you have a paid cluster, you can also access the guestbook app via the subdomain you saved in exercise 5.</p>

<h3 id="toc_59">Implementing circuit breakers with destination rules</h3>

<p>Istio <code>DestinationRules</code> allow users to configure Envoy&#39;s implementation of <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/circuit_breaking">circuit breakers</a>. Circuit breakers are critical for defining the behavior for service-to-service communication in the service mesh. In the event of a failure for a particular service, circuit breakers allow users to set global defaults for failure recovery on a per service and/or per service version basis. Users can apply a <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3.html#TrafficPolicy">traffic policy</a> at the top level of the <code>DestinationRule</code> to create circuit breaker settings for an entire service, or it can be defined at the subset level to create settings for a particular version of a service.</p>

<p>Depending on whether a service handles <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#ConnectionPoolSettings.HTTPSettings">HTTP</a> requests or <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#ConnectionPoolSettings.TCPSettings">TCP</a> connections, <code>DestinationRules</code> expose a number of ways for Envoy to limit traffic to a particular service as well as define failure recovery behavior for services initiating the connection to an unhealthy service.</p>

<h2 id="toc_60">Further reading</h2>

<ul>
<li><a href="https://istio.io/docs/concepts/traffic-management/">Istio Concept</a></li>
<li><a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3">Istio Rules API</a></li>
<li><a href="https://istio.io/docs/reference/commands/istioctl.html#istioctl%20experimental%20convert-networking-config">Istio V1alpha1 to V1alpha3 Converter Tool</a></li>
<li><a href="https://istio.io/docs/reference/commands/istioctl/#istioctl%20proxy-config">Istio Proxy Debug Tool</a></li>
<li><a href="https://blog.openshift.com/istio-traffic-management-diving-deeper/">Traffic Management</a></li>
<li><a href="https://blog.openshift.com/microservices-patterns-envoy-part-i/">Circuit Breaking</a></li>
<li><a href="https://blog.openshift.com/microservices-patterns-envoy-proxy-part-ii-timeouts-retries/">Timeouts and Retries</a></li>
</ul>

<h2 id="toc_61">Questions</h2>

<ol>
<li>Where are routing rules defined?  Options: (VirtualService, DestinationRule, ServiceEntry)  Answer: VirtualService</li>
<li>Where are service versions (subsets) defined?  Options: (VirtualService, DestinationRule, ServiceEntry)  Answer: DestinationRule</li>
<li>Which Istio component is responsible for sending traffic management configurations to Istio sidecars?  Options: (Mixer, Citadel, Pilot, Kubernetes)  Answer: Pilot</li>
<li>What is the name of the default proxy that runs in Istio sidecars and routes requests within the service mesh?  Options: (NGINX, Envoy, HAProxy)  Answer: Envoy</li>
</ol>

<h4 id="toc_62">Hint Perform traffic management</h4>

<p>No hint available</p>

<h4 id="toc_63">Complete Perform traffic management</h4>

<blockquote>
<p>Confirm Perform traffic management complete</p>
</blockquote>

<h4 id="toc_64">Task Secure your services</h4>

<hr>

<h1 id="toc_65">Exercise 7 - Secure your services</h1>

<h2 id="toc_66">Mutual authentication with Transport Layer Security (mTLS)</h2>

<p>Istio can secure the communication between microservices without requiring application code changes. Security is provided by authenticating and encrypting communication paths within the cluster. This is becoming a common security and compliance requirement. Delegating communication security to Istio (as opposed to implementing TLS in each microservice), ensures that your application will be deployed with consistent and manageable security policies.</p>

<p>Istio Citadel is an optional part of Istio&#39;s control plane components. When enabled, it provides each Envoy sidecar proxy with a strong (cryptographic) identity, in the form of a certificate.
Identity is based on the microservice&#39;s service account and is independent of its specific network location, such as cluster or current IP address.
Envoys then use the certificates to identify each other and establish an authenticated and encrypted communication channel between them.</p>

<p>Citadel is responsible for:</p>

<ul>
<li><p>Providing each service with an identity representing its role.</p></li>
<li><p>Providing a common trust root to allow Envoys to validate and authenticate each other.</p></li>
<li><p>Providing a key management system, automating generation, distribution, and rotation of certificates and keys.</p></li>
</ul>

<p>When an application microservice connects to another microservice, the communication is redirected through the client side and server side Envoys. The end-to-end communication path is:</p>

<ul>
<li><p>Local TCP connection (i.e., <code>localhost</code>, not reaching the &quot;wire&quot;) between the application and Envoy (client- and server-side);</p></li>
<li><p>Mutually authenticated and encrypted connection between Envoy proxies.</p></li>
</ul>

<p>When Envoy proxies establish a connection, they exchange and validate certificates to confirm that each is indeed connected to a valid and expected peer. The established identities can later be used as basis for policy checks (e.g., access authorization).</p>

<h2 id="toc_67">Steps</h2>

<blockquote>
<p>Version 2 of the guestbook application uses an external service (tone analyzer) which is not Istio-enabled.
Thus, we will disable mTLS globally and enable it only for communication between internal cluster services in this lab.</p>
</blockquote>

<ol>
<li><p>Ensure Citadel is running</p>

<p>Citadel is Istio&#39;s in-cluster Certificate Authority (CA) and is required for generating and managing cryptographic identities in the cluster.
Verify Citadel is running:</p>

<div><pre><code class="language-shell">kubectl get deployment -l istio=citadel -n istio-system</code></pre></div>

<p>Expected output:</p>

<div><pre><code class="language-shell">NAME            DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
istio-citadel   1         1         1            1           15h</code></pre></div></li>
<li><p>Define mTLS Authentication Policy</p>

<p>Define mTLS authentication policy for the analyzer service:</p></li>
</ol>

<div><pre><code class="language-shell">cat &lt;&lt;EOF | kubectl create -f -
apiVersion: authentication.istio.io/v1alpha1
kind: Policy
metadata:
  name: mtls-to-analyzer
  namespace: default
spec:
  targets:
  - name: analyzer
  peers:
  - mtls:
EOF</code></pre></div>

<div><pre><code class="language-none">You should see:
```shell
policy.authentication.istio.io/mtls-to-analyzer created
```

Confirm the policy has been created:
```shell
kubectl get policies.authentication.istio.io
```
Output:
```shell
NAME              AGE
mtls-to-analyzer  1m
```</code></pre></div>

<ol>
<li>Enable mTLS from guestbook using a Destination rule</li>
</ol>

<div><pre><code class="language-shell">cat &lt;&lt;EOF | kubectl create -f -
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: route-with-mtls-for-analyzer
  namespace: default
spec:
  host: &quot;analyzer.default.svc.cluster.local&quot;
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
EOF</code></pre></div>

<div><pre><code class="language-none">Output:
```
destinationrule.networking.istio.io/route-with-mtls-for-analyzer created
```</code></pre></div>

<h2 id="toc_68">Verifying the Authenticated Connection</h2>

<p>If mTLS is working correctly, the Guestbook app should continue to operate as expected, without any user visible impact. Istio will automatically add (and manage) the required certificates and private keys. </p>

<h2 id="toc_69">Further Reading</h2>

<ul>
<li><p><a href="https://dzone.com/articles/tlsssl-terminology-and-basics">Basic TLS/SSL Terminology</a></p></li>
<li><p><a href="https://www.ibm.com/support/knowledgecenter/en/SSFKSJ_7.1.0/com.ibm.mq.doc/sy10660_.htm">TLS Handshake Explained</a></p></li>
<li><p><a href="https://istio.io/docs/tasks/security/mutual-tls.html">Istio Task</a></p></li>
<li><p><a href="https://istio.io/docs/concepts/security/mutual-tls.html">Istio Concept</a></p></li>
</ul>

<h4 id="toc_70">Hint Secure your services</h4>

<p>No hint available</p>

<h4 id="toc_71">Complete Secure your services</h4>

<blockquote>
<p>Confirm Secure your services complete</p>
</blockquote>

<h4 id="toc_72">Task Enforce policies</h4>

<hr>

<h1 id="toc_73">Exercise 8 - Enforce policies for microservices</h1>

<p>Backend systems such as access control systems, telemetry capturing systems, quota enforcement systems, billing systems, and so forth, traditionally directly integrate with services, creating a hard coupling and baking-in specific semantics and usage options.</p>

<p>Istio Mixer provides a generic intermediation layer between app code and infrastructure backends. Its design moves policy decisions out of the app layer and into configuration instead, under operator control. Instead of having app code integrate with specific backends, the app code instead does a fairly simple integration with Mixer, and Mixer takes responsibility for interfacing with the backend systems.</p>

<p>Given that individual infrastructure backends each have different interfaces and operational models, Mixer needs custom code to deal with each and we call these custom bundles of code <strong>adapters</strong>. Some built-in adapters include denier, prometheus,  memquota, and stackdriver.</p>

<p>In this exercise we&#39;ll use the denier adapter.</p>

<h2 id="toc_74">Service isolation with the denier adapter</h2>

<ol>
<li><p>Block access to Guestbook service:</p>

<div><pre><code class="language-shell">kubectl create -f mixer-rule-denial.yaml</code></pre></div>

<p>Let&#39;s examine the rule:
<code>yaml
    apiVersion: &quot;config.istio.io/v1alpha2&quot;
    kind: denier
    metadata:
      name: denyall
      namespace: istio-system
    spec:
      status:
        code: 7
        message: Not allowed
    ---
    # The (empty) data handed to denyall at run time
    apiVersion: &quot;config.istio.io/v1alpha2&quot;
    kind: checknothing
    metadata:
      name: denyrequest
      namespace: istio-system
    spec:
    ---
    # The rule that uses denier to deny requests to the guestbook service
    apiVersion: &quot;config.istio.io/v1alpha2&quot;
    kind: rule
    metadata:
      name: deny-hello-world
      namespace: istio-system
    spec:
      match: destination.service==&quot;guestbook.default.svc.cluster.local&quot;
      actions:
      - handler: denyall.denier
        instances:
        - denyrequest.checknothing
</code></p></li>
<li><p>Verify that the service is denied:</p>

<p>In <a href="../exercise-5/README.md">Exercise 5</a>, we created the Ingress resource. Make sure the $INGRESS_IP environment variable is still present. Then in the terminal, try:</p>

<div><pre><code class="language-shell">curl http://$INGRESS_IP/</code></pre></div>

<p>You should see the error message <code>PERMISSION_DENIED:denyall.denier.istio-system:Not allowed</code>.</p>

<p>You can also try visiting the guestbook app in the browser, and you should see the same error message.</p></li>
<li><p>Clean up the rule.</p>

<div><pre><code class="language-shell">kubectl delete -f mixer-rule-denial.yaml</code></pre></div></li>
</ol>

<h2 id="toc_75">Further reading</h2>

<ul>
<li><a href="https://istio.io/docs/concepts/policy-and-control/mixer.html">Istio Mixer</a></li>
<li><a href="https://medium.com/@szihai_37982/how-to-write-istio-mixer-policies-50dc639acf75">How to write istio mixer policies</a></li>
</ul>

<h4 id="toc_76">Hint Enforce policies</h4>

<p>No hint available</p>

<h4 id="toc_77">Complete Enforce policies</h4>

<blockquote>
<p>Confirm Enforce policies complete</p>
</blockquote>

<h4 id="toc_78">Task Quiz</h4>

<hr>

<h2 id="toc_79">Quiz</h2>

<ol>
<li><p>Does creating mixer rules require app code changes? </p>

<div><pre><code class="language-none">A. Yes 
B. No </code></pre></div></li>
<li><p>The custom code that interacts with the backend system, i.e. Prometheus, is called</p>

<div><pre><code class="language-none">A. Rule 
B. Instance 
C. Adapter</code></pre></div></li>
<li><p>Istio Citadel provides each microservice with a strong, cryptographic, identity in the form of a certificate. The certificates&#39; life cycle is fully managed by Istio. </p>

<div><pre><code class="language-none">A. True 
B. False  </code></pre></div></li>
<li><p>Istio provides microservices with mutually authenticated connections, without requiring app code changes.</p>

<div><pre><code class="language-none">A. True 
B. False  </code></pre></div></li>
<li><p>Mutual authentication must be on or off for the entire cluster, gradual adoption is not possible. </p>

<div><pre><code class="language-none">A. True 
B. False  </code></pre></div></li>
<li><p>Which of the following are the features provided by Istio?</p>

<div><pre><code class="language-none">A. Traffic Management   
B. Telemtry   
C. Policy Enforcement
D. Machine Learning
E. Mutual TLS
F. API Connect  </code></pre></div></li>
<li><p>Can microservices deployed in Istio communicate to services outside of Istio?</p>

<div><pre><code class="language-none">A. Yes 
B. No</code></pre></div></li>
<li><p>Which Istio function normally requires user to modify their application?</p>

<div><pre><code class="language-none">A. Traffic Management   
B. Metrics   
C Distributed Tracing   
D. Policy Enforcement </code></pre></div></li>
<li><p>Which Istio component is always required when user chooses to only install certain Istio features?</p>

<div><pre><code class="language-none">A. Mixer  
B. Pilot
C. Citadel
D. Istioctl</code></pre></div></li>
<li><p>Which Istio components below are part of the Istio service mesh data plane?</p>

<div><pre><code class="language-none">A. Mixer  
B. Pilot  
C. Citadel  
D. Envoy side car</code></pre></div></li>
<li><p>Which Istio features allow user to configure per namespace?</p>

<div><pre><code class="language-none">A. Policy enforcement
B. Traffic Management
C. Authentication Policy
D. Telemtry</code></pre></div></li>
<li><p>To leverage Istio, does my service have to run in Kubernetes?</p>

<div><pre><code class="language-none">A. Yes 
B. No</code></pre></div></li>
<li><p>What’s the purpose of sidecar container in Kubernetes?</p>

<div><pre><code class="language-none">A. It’s a container with Istio installed
B. It’s utility container in the pod
C. It helps to speed up the cluster run time
D. None of the above</code></pre></div></li>
<li><p>What Istio component primarily manages telemetry ? </p>

<div><pre><code class="language-none">A. Pilot
B. Istio-auth
C. Mixer
D. Istio data plane</code></pre></div></li>
<li><p>What’s an Envoy?</p>

<div><pre><code class="language-none">A. It’s web server
B. It’s sidecar proxy
C. Both
D. None</code></pre></div></li>
<li><p>What component is primarily responsible for traffic management?</p>

<div><pre><code class="language-none">A. Pilot
B. Mixer
C. Istio-auth
D. Security</code></pre></div></li>
<li><p>A VirtualService defines policies that apply to traffic intended for a service after routing has occurred.</p>

<div><pre><code class="language-none">A. Yes
B. No</code></pre></div></li>
<li><p>ServiceEntry configuration enables services within the mesh to access a service not necessarily managed by Istio.</p>

<div><pre><code class="language-none">A. Yes
B. No</code></pre></div></li>
<li><p>A/B is a method of performing identical tests against two separate service versions in order to determine which performs better.</p>

<div><pre><code class="language-none">A. Yes
B. No</code></pre></div></li>
<li><p>What is the default side car proxy in Istio?</p>

<div><pre><code class="language-none">A. Nginx
B. Linkerd
C. Envoy
D. None of the above</code></pre></div></li>
<li><p>With what Istio components one can enable users to write custom adapters for tracing and metrics?</p>

<div><pre><code class="language-none">A. Istio-auth
B. Mixer
C. Pilot
D. Envoy</code></pre></div></li>
</ol>

<h4 id="toc_80">Hint Quiz</h4>

<p>No hint available</p>

<h4 id="toc_81">Complete Quiz</h4>

<blockquote>
<p>Confirm Quiz complete</p>
</blockquote>



<script type="text/javascript">
var _self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{},Prism=function(){var e=/\blang(?:uage)?-(\w+)\b/i,t=0,n=_self.Prism={util:{encode:function(e){return e instanceof a?new a(e.type,n.util.encode(e.content),e.alias):"Array"===n.util.type(e)?e.map(n.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},objId:function(e){return e.__id||Object.defineProperty(e,"__id",{value:++t}),e.__id},clone:function(e){var t=n.util.type(e);switch(t){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=n.util.clone(e[r]));return a;case"Array":return e.map&&e.map(function(e){return n.util.clone(e)})}return e}},languages:{extend:function(e,t){var a=n.util.clone(n.languages[e]);for(var r in t)a[r]=t[r];return a},insertBefore:function(e,t,a,r){r=r||n.languages;var l=r[e];if(2==arguments.length){a=arguments[1];for(var i in a)a.hasOwnProperty(i)&&(l[i]=a[i]);return l}var o={};for(var s in l)if(l.hasOwnProperty(s)){if(s==t)for(var i in a)a.hasOwnProperty(i)&&(o[i]=a[i]);o[s]=l[s]}return n.languages.DFS(n.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=o)}),r[e]=o},DFS:function(e,t,a,r){r=r||{};for(var l in e)e.hasOwnProperty(l)&&(t.call(e,l,e[l],a||l),"Object"!==n.util.type(e[l])||r[n.util.objId(e[l])]?"Array"!==n.util.type(e[l])||r[n.util.objId(e[l])]||(r[n.util.objId(e[l])]=!0,n.languages.DFS(e[l],t,l,r)):(r[n.util.objId(e[l])]=!0,n.languages.DFS(e[l],t,null,r)))}},plugins:{},highlightAll:function(e,t){var a={callback:t,selector:'code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'};n.hooks.run("before-highlightall",a);for(var r,l=a.elements||document.querySelectorAll(a.selector),i=0;r=l[i++];)n.highlightElement(r,e===!0,a.callback)},highlightElement:function(t,a,r){for(var l,i,o=t;o&&!e.test(o.className);)o=o.parentNode;o&&(l=(o.className.match(e)||[,""])[1],i=n.languages[l]),t.className=t.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,o=t.parentNode,/pre/i.test(o.nodeName)&&(o.className=o.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var s=t.textContent,u={element:t,language:l,grammar:i,code:s};if(!s||!i)return n.hooks.run("complete",u),void 0;if(n.hooks.run("before-highlight",u),a&&_self.Worker){var c=new Worker(n.filename);c.onmessage=function(e){u.highlightedCode=e.data,n.hooks.run("before-insert",u),u.element.innerHTML=u.highlightedCode,r&&r.call(u.element),n.hooks.run("after-highlight",u),n.hooks.run("complete",u)},c.postMessage(JSON.stringify({language:u.language,code:u.code,immediateClose:!0}))}else u.highlightedCode=n.highlight(u.code,u.grammar,u.language),n.hooks.run("before-insert",u),u.element.innerHTML=u.highlightedCode,r&&r.call(t),n.hooks.run("after-highlight",u),n.hooks.run("complete",u)},highlight:function(e,t,r){var l=n.tokenize(e,t);return a.stringify(n.util.encode(l),r)},tokenize:function(e,t){var a=n.Token,r=[e],l=t.rest;if(l){for(var i in l)t[i]=l[i];delete t.rest}e:for(var i in t)if(t.hasOwnProperty(i)&&t[i]){var o=t[i];o="Array"===n.util.type(o)?o:[o];for(var s=0;s<o.length;++s){var u=o[s],c=u.inside,g=!!u.lookbehind,h=!!u.greedy,f=0,d=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var m=r[p];if(r.length>e.length)break e;if(!(m instanceof a)){u.lastIndex=0;var y=u.exec(m),v=1;if(!y&&h&&p!=r.length-1){var b=r[p+1].matchedStr||r[p+1],k=m+b;if(p<r.length-2&&(k+=r[p+2].matchedStr||r[p+2]),u.lastIndex=0,y=u.exec(k),!y)continue;var w=y.index+(g?y[1].length:0);if(w>=m.length)continue;var _=y.index+y[0].length,P=m.length+b.length;if(v=3,P>=_){if(r[p+1].greedy)continue;v=2,k=k.slice(0,P)}m=k}if(y){g&&(f=y[1].length);var w=y.index+f,y=y[0].slice(f),_=w+y.length,S=m.slice(0,w),O=m.slice(_),j=[p,v];S&&j.push(S);var A=new a(i,c?n.tokenize(y,c):y,d,y,h);j.push(A),O&&j.push(O),Array.prototype.splice.apply(r,j)}}}}}return r},hooks:{all:{},add:function(e,t){var a=n.hooks.all;a[e]=a[e]||[],a[e].push(t)},run:function(e,t){var a=n.hooks.all[e];if(a&&a.length)for(var r,l=0;r=a[l++];)r(t)}}},a=n.Token=function(e,t,n,a,r){this.type=e,this.content=t,this.alias=n,this.matchedStr=a||null,this.greedy=!!r};if(a.stringify=function(e,t,r){if("string"==typeof e)return e;if("Array"===n.util.type(e))return e.map(function(n){return a.stringify(n,t,e)}).join("");var l={type:e.type,content:a.stringify(e.content,t,r),tag:"span",classes:["token",e.type],attributes:{},language:t,parent:r};if("comment"==l.type&&(l.attributes.spellcheck="true"),e.alias){var i="Array"===n.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(l.classes,i)}n.hooks.run("wrap",l);var o="";for(var s in l.attributes)o+=(o?" ":"")+s+'="'+(l.attributes[s]||"")+'"';return"<"+l.tag+' class="'+l.classes.join(" ")+'" '+o+">"+l.content+"</"+l.tag+">"},!_self.document)return _self.addEventListener?(_self.addEventListener("message",function(e){var t=JSON.parse(e.data),a=t.language,r=t.code,l=t.immediateClose;_self.postMessage(n.highlight(r,n.languages[a],a)),l&&_self.close()},!1),_self.Prism):_self.Prism;var r=document.currentScript||[].slice.call(document.getElementsByTagName("script")).pop();return r&&(n.filename=r.src,document.addEventListener&&!r.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",n.highlightAll)),_self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism),"undefined"!=typeof global&&(global.Prism=Prism);
</script>

<script type="text/javascript">
Prism.languages.yaml={scalar:{pattern:/([\-:]\s*(![^\s]+)?[ \t]*[|>])[ \t]*(?:((?:\r?\n|\r)[ \t]+)[^\r\n]+(?:\3[^\r\n]+)*)/,lookbehind:!0,alias:"string"},comment:/#.*/,key:{pattern:/(\s*[:\-,[{\r\n?][ \t]*(![^\s]+)?[ \t]*)[^\r\n{[\]},#]+?(?=\s*:\s)/,lookbehind:!0,alias:"atrule"},directive:{pattern:/(^[ \t]*)%.+/m,lookbehind:!0,alias:"important"},datetime:{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)(\d{4}-\d\d?-\d\d?([tT]|[ \t]+)\d\d?:\d{2}:\d{2}(\.\d*)?[ \t]*(Z|[-+]\d\d?(:\d{2})?)?|\d{4}-\d{2}-\d{2}|\d\d?:\d{2}(:\d{2}(\.\d*)?)?)(?=[ \t]*($|,|]|}))/m,lookbehind:!0,alias:"number"},"boolean":{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)(true|false)[ \t]*(?=$|,|]|})/im,lookbehind:!0,alias:"important"},"null":{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)(null|~)[ \t]*(?=$|,|]|})/im,lookbehind:!0,alias:"important"},string:{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')(?=[ \t]*($|,|]|}))/m,lookbehind:!0},number:{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)[+\-]?(0x[\da-f]+|0o[0-7]+|(\d+\.?\d*|\.?\d+)(e[\+\-]?\d+)?|\.inf|\.nan)[ \t]*(?=$|,|]|})/im,lookbehind:!0},tag:/![^\s]+/,important:/[&*][\w]+/,punctuation:/---|[:[\]{}\-,|>?]|\.\.\./};
</script>


</body>

</html>
